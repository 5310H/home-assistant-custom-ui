<link rel="import" href="state-card-with-slider.html" async>

<script>
Polymer({
  is: 'state-card-custom-ui',

  properties: {
    hass: {
      type: Object,
    },

    inDialog: {
      type: Boolean,
      value: false,
    },

    stateObj: {
      type: Object,
    },
  },

  observers: [
    'inputChanged(hass, inDialog, stateObj)',
  ],

  _getContext: function () {
    var element = this;
    if (this._context === undefined) {
      while (element && element.tagName !== 'HA-ENTITIES-CARD') {
        element = element.domHost;
      }
      if (element && element.groupEntity !== undefined) {
        if (element.groupEntity) {
          this._context = element.groupEntity.entity_id;
        } else if (element.states && element.states.length) {
          this._context = 'group.' + window.hassUtil.computeDomain(element.states[0]);
        }
      } else {
        this._context = null;
      }
    }
    return this._context;
  },

  _maybeChangeName: function (stateObj, inDialog) {
    if (inDialog) return stateObj;
    var context = this._getContext();
    if (!context) return stateObj;
    if (!stateObj.attributes.friendly_names ||
        !stateObj.attributes.friendly_names[context]) {
      return stateObj;
    }
    return {
      entity_id: stateObj.entity_id,
      _entityDisplay: stateObj.attributes.friendly_names[context],
      state: stateObj.state,
      attributes: stateObj.attributes,
      last_changed: stateObj.last_changed,
    };
  },

  inputChanged: function (hass, inDialog, stateObj) {
    var stateCardType;
    var domain;
    if (!stateObj || !hass) return;

    var params = {
      hass: hass,
      stateObj: this._maybeChangeName(stateObj, inDialog),
      inDialog: inDialog,
    };
    domain = window.hassUtil.computeDomain(stateObj);
    stateCardType = window.hassUtil.stateCardType(hass, stateObj);
    if (domain === 'light' || domain === 'cover') {
      stateCardType = 'with-slider';
      Object.assign(params, {
        domain: domain,

      });
    }
    if (domain === 'light') {
      Object.assign(params, {
        controlElement: 'ha-entity-toggle',
        serviceMin: 'turn_off',
        serviceMax: 'turn_on',
        valueName: 'brightness',
      });
    }
    if (domain === 'cover') {
      Object.assign(params, {
        controlElement: 'ha-cover-controls',
        max: 100,
        serviceMin: 'close_cover',
        serviceMax: 'set_cover_position',
        setValueName: 'position',
        valueName: 'current_position',
        nameOn: 'open',
      });
    }
    window.hassUtil.dynamicContentUpdater(
      this,
      'STATE-CARD-' + stateCardType.toUpperCase(),
      params);
  },
});
</script>
